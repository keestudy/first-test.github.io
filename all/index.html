<html>
	<head>
		<meta charset="utf-8" />
		<title>洛阳市地名演变知识图谱可视化平台</title>
		<link href="../static/css/style.css" type="text/css" rel="stylesheet" />
		<script src="../static/js/jquery-3.4.1.min.js"></script>
		<link rel="stylesheet" href="../static/js/bootstrap.min.css" />
		<script src="../static/js/bootstrap.min.js"></script>
		<script src="../static/js/alert.js"></script>
		<script src="../static/js/split.js"></script>
		<script src="../static/js/cytoscape.min.js"></script>



		<!--<script src="https://unpkg.com/cytoscape/dist/cytoscape.min.js"></script>
		<script src="http://marvl.infotech.monash.edu/webcola/cola.min.js"></script>
		<script src="https://unpkg.com/cytoscape-cola/cytoscape-cola.js"></script>-->
		<script src="../static/js/axios.min.js"></script>

		<script type="text/javascript" src="http://api.tianditu.gov.cn/api?v=4.0&tk=eb810202b6ab9b263b4d5ac47fe772ab">
		</script>

		<script>
			function balert(str) {
				success_prompt(str);
			}

			function quickin(text0) {
				const user_input = document.getElementById('shuru');
				// get the value and use as needed
				let user_input_value = user_input.value;
				user_input.value = text0;
			}
		</script>
		<script>
			$(function() {
				$.get('/graph', function(result) {
					console.log(result.elements);
					cy = cytoscape({
						container: document.getElementById('cy1'),
						style: [{
								selector: 'node',
								style: {
									'pointer-events': 'all' // 允许节点上的所有鼠标事件
								}
							},
							{
								selector: 'node[label = "Place-name"]',
								style: {
									//'opacity':0.5,
									'font-size': 10,
									'background-color': 'rgba(16, 162, 234,0.8)',
									'content': 'data(name)',
									'text-valign': 'center'
								}
							},
							{
								selector: 'node[label = "New"]',
								style: {
									//'opacity':0.5,
									'font-size': 10,
									'background-color': 'rgba(0, 170, 0,0.8)',
									'content': 'data(name)',
									'text-valign': 'center'
								}
							},
							{
								selector: 'node[label = "Dynasty"]',
								style: {
									'font-size': 10,
									'background-color': 'rgba(245,164,93,0.8)',
									'content': 'data(name)',
									'text-valign': 'center',
									'color': '#646464'
								}
							},
							/*{
								selector: 'node[label = "Years"]',
								style: {
									'font-size': 10,
									'background-color': 'rgba(233,201,241,0.8)',
									'content': 'data(name)',
									'text-valign': 'center',
									'color': '#646464'
								}
							},*/
							{
								selector: 'edge',
								style: {
									'content': 'data(relationship)',
									'font-size': 8,
									'width': 0.8,
									'line-color': 'pink',
									'target-arrow-color': '#3f3f3f',
									'target-arrow-shape': 'vee',
									'curve-style': 'bezier',
									'color': 'purple'
								}
							},
							{
								selector: 'edge[relationship = "start_in"]',
								style: {
									'width': 0.6,
									'line-color': '#e8e873',
									'color': 'gray'
								}
							},
							{
								selector: 'edge[relationship = "next"]',
								style: {
									'width': 0.6,
									'line-color': '#000000',
									'color': 'black'
								}
							},
							{
								selector: 'edge[relationship = "contain"]',
								style: {
									'width': 0.6,
									'line-color': 'blue',
									'color': 'gray'
								}
							}
						],
						layout: {
							//name: 'cola',
							//infinite: true, 
							//fit: true, 
							//centerGraph: false
							name: 'cose', //cose,
							componentSpacing: 80, //非复合图中组件之间的额外间距  40
							nodeOverlap: 10, //节点排斥(重叠)乘数 4
							fit: true,

						},
						elements: result.elements
					});








					cy.minZoom(0.1); //获取或设置最小缩放级别。
					cy.maxZoom(10);

					//console.log(cy.elements('nodes'));
					cy.on('tap', 'node', function(evt) {
						var node = evt.target;

						axios.post("/login", {
							nodeid: node.id()
						}).then((res) => {
							//console.log(res.data.n);
							var txt =
								"<table><thead><tr><th>属性名</th><th>属性值</th></tr></thead><tbody>";
							for (var i in res.data.n) {
								txt += "<tr><td>" + i + "</td><td>" + res.data.n[i] +
									"</td></tr>";
							};
							txt += "</tbody></table>";
							$('#nodeIN').html(txt); //res.data
						}).catch(error => {
							console.error(error);
						})
					});
					cy.on('tap', 'edge', function(evt) {
						var edge = evt.target;
						//console.log('tapped ' + edge.data()['relationship']);
						axios.post("/edgeinfo", {
							id101: edge.data()['id101']
						}).then((res) => {
							//console.log(res.data.r);
							var txt =
								"<table><thead><tr><th>属性名</th><th>属性值</th></tr></thead><tbody>";
							for (var i in res.data.r) {
								txt += "<tr><td>" + i + "</td><td>" + res.data.r[i] +
									"</td></tr>";
							};
							txt += "</tbody></table>";
							$('#nodeIN').html(txt); //res.data
						}).catch(error => {
							console.error(error);
						})
					});

					cy.on('taphold', 'node', function(evt) {
						var node = evt.target;
						//var j =cy.$(':selected');
						//console.log('t ' + node.id());
						//cy.remove( j );
						cy.$(':selected').unselect();
						const sid = evt.target.id()
						var selectedNode = cy.getElementById(sid).select();
						//var selectedNodes = cy.filter('node[label="Years"]');
						let neighborhood = cy.getElementById(sid).neighborhood().select();
						//neighborhood.style('background-color', 'red');
						// 获取所有元素
						var allElements = cy.elements();
						// 获取已选择的元素
						var selectedElements = cy.elements(':selected');
						//console.log(selectedElements);
						// 获取未选择的元素
						var unselectedElements = allElements.difference(selectedElements);
						// 将未选择的元素设为不可见
						//unselectedElements.filter(':display').style('display', 'none');
						unselectedElements.style('display', 'none');
						var layout = cy.layout({
							name: 'cose',
							fit: true
						});
						layout.run();
						cy.zoom(5);
						document.getElementById('bcy2').style.fontWeight = "bold";
						document.getElementById('bcy1').style.fontWeight = "normal";
					});

					//右击
					cy.on('cxttap', 'node', function(evt) { //cxttap
						var node = evt.target;
						currentid = node.id();
						currentname = node.data()['name'];
						//console.log('tapped ' + node.data()['name']);
						axios.post("/CNinfo", {
							name101: node.data()[
								'name']
						}).then((res) => {
							//console.log(res.data);
							var arr = res.data[
								'ret'];

							if (res.data[
									'status'] =
								'ok') {
								var ss = '成功'
							} else {
								var ss = '失败'
							}
							res.data['status']
							balert('获取' + ss +
								'。得到' + arr
								.length +
								'条记录。');
							var txt =
								'<table><thead><tr><th>序号</th><th>值</th></tr></thead><tbody>';
							for (var i = 0; i <
								arr.length; i++
							) {
								var ttt = arr[i];
								txt +=
									'<tr><td>' +
									String(i +
										1) +
									'</td><td>' +
									'<u onclick="CN01(&quot;' +
									ttt +
									'&quot;)">' +
									arr[i] +
									'</u></td></tr>';
							};
							txt +=
								'</tbody></table>';
							$('#nodeCN').html(
								txt); //res.data

						}).catch(error => {
							console.error(error);
						})
					});

					//双击
					cy.on('dbltap', 'node', function(evt) { //dblclickdbltap//
						console.log("shuangji");
						var node = evt.target;
						currentid = node.id();
						currentname = node.data()['name'];
						//console.log('tapped ' + node.data()['name']);
						axios.post("/TGinfo", {
							name101: node.data()[
								'name']
						}).then((res) => {
							//console.log(res.data);
							balert('获取成功。得到' +
								res
								.data[
									'count of total results'
								] + '条记录'
							);
							var arr = res.data[
								'placenames'];
							var txt =
								'<table><thead><tr><th>序号(+)</th><th>名称</th><th>起止年代</th><th>所处</th><th>坐标</th></tr></thead><tbody>';
							for (var i = 0; i <
								arr.length; i++
							) {
								var ttt = arr[i];
								txt +=
									'<tr><td>' +
									'<u class="buttonu" onclick="ADD02(&quot;' +
									ttt['parent name'] +
									'&quot;)">' +
									String(i + 1) +
									'</u>' +
									'</td><td>' +
									'<a href=' +
									ttt['uri'] +
									' target="_blank">' +
									ttt['name'] +
									'</a></td><td>' +
									ttt[
										'years'
									] +
									'</td><td>' +
									'<a href=' +
									'https://maps.cga.harvard.edu/tgaz/placename/' +
									ttt[
										'parent sys_id'
									] +
									' target="_blank">' +
									ttt[
										'parent name'
									] +
									'</a></td><td>' +
									'<u onclick="TG02(&quot;' +
									ttt[
										'xy coordinates'
									] +
									'&quot;)">' +
									ttt[
										'xy coordinates'
									] +
									'</u></td></tr>';
							};
							txt +=
								'</tbody></table>';
							$('#nodeCN').html(
								txt); //res.data

						}).catch(error => {
							console.error(error);
						})
					});

				}, 'json');
			});
		</script>
	</head>
	<body>
		<div class="all">
			<div class="top">
				<button class="type0" id="bcy1" type="text" onclick="forceon()">全图</button>
				<button class="type1" id="bcy2" type="text" onclick="forcetwo()">细节图</button>
				<button class="type1" id="bmap" type="text" onclick="forcemap()">地图</button>
				<form>
					展示节点类型：<input type="checkbox" name="p1" checked onchange="ch1()">Place name
					<input type="checkbox" name="y2" checked onchange="ch2()">Dynasty
					<br>
					展示关系类型：<input type="checkbox" name="p0p1" checked onchange="por1()">next
					<input type="checkbox" name="p0p2" checked onchange="por2()">contain
					<input type="checkbox" name="p0p3" checked onchange="por3()">start_in
					<input type="checkbox" name="p0p4" checked onchange="por4()">新建
					<input type="checkbox" name="p0p5" checked onchange="por5()">撤销
					<input type="checkbox" name="p0p6" checked onchange="por6()">改名
					<input type="checkbox" name="p0p7" checked onchange="por7()">管辖
					<input type="checkbox" name="p0p8" checked onchange="por8()">被管辖
				</form>
				<div id="QA">
					<div class="form-top">
						<button class="btn btn-primary" type="button" data-toggle="collapse"
							data-target="#collapseExample" aria-expanded="false" aria-controls="collapseExample">
							问答窗口
						</button>
					</div>
					<div class="collapse" id="collapseExample">
						<div class="form-group0" id="coll1">
							<p class="leftp">目前提供的问题模板有：
								<br>1、<u onclick="quickin(this.innerHTML)">A从古到今的变化</u>（A指要查询的地点，默认为洛阳）
								<br>2、<u onclick="quickin(this.innerHTML)">显示与X相关的节点N层</u>（X指要查询的节点名称，N为展开的关系层数，默认为1）
								<br>3、<u onclick="quickin(this.innerHTML)">在Y洛阳的名称</u>（Y指要查询朝代，如唐朝）
							</p>
							<!--<asp:RadioButtonList ID="rblClasses" runat="server" DataTextField="className"
								DataValueField="classID" ForeColor="#FF4040">
							</asp:RadioButtonList>-->
						</div>

						<div class="form-line">
							<input id="shuru" placeholder="..." name="keyword" type="text">
							<button class="type3" type="text" onclick="submit02()">发送</button>
						</div>
					</div>
				</div>
			</div>
			<div id="mian" class="hj-wrap">
				<div id="cy" class="hj-transverse-split-div">
					<div id="cy1">
					</div>
					<div id="cy2" style="display:none">
					</div>
					<div id="map" style="display:none">
					</div>
					<label class="hj-transverse-split-label"></label>
				</div>
				<div id="node" class="hj-transverse-split-div verticals">
					<div id="nodeIN1" class="hj-vertical-split-div">
						<div id="nodeIN">
							<asp:RadioButtonList ID="rblClasses" runat="server" DataTextField="className"
								DataValueField="classID" ForeColor="#FF4040">
							</asp:RadioButtonList>
						</div>
						<label class="hj-vertical-split-label"></label>
					</div>
					<div id="nodeCN" class="hj-vertical-split-div">
						<asp:RadioButtonList ID="rblClasses" runat="server" DataTextField="className"
							DataValueField="classID" ForeColor="#FF4040">
						</asp:RadioButtonList>
					</div>
				</div>
			</div>
		</div>

		<script>
			newnodeindex = 1;

			function ADD01(add_p_name) {
				//currentid=node.id();
				//currentname=node.data()['name'];
				// 创建一个输入框元素
				var inputtxt = document.createElement("p");
				inputtxt.innerHTML = '新建节点名称为“' + add_p_name + '”；与已有节点“' + currentname + '”建立“' + currentname + '”->“' +
					add_p_name + '”关系' + '<br>输入关系的类型：';
				var inputBox = document.createElement('input');
				inputBox.type = 'text';
				console.log(currentid);
				// 创建一个确定按钮元素
				var okButton = document.createElement('button');
				okButton.innerHTML = '确定';
				// 创建一个取消按钮元素
				var cancelButton = document.createElement('button');
				cancelButton.innerHTML = '取消';
				// 创建一个容器元素，用于包含输入框和按钮
				var container = document.createElement('div');
				container.setAttribute("class", "open-end-div");
				container.appendChild(inputtxt);
				container.appendChild(inputBox);
				container.appendChild(okButton);
				container.appendChild(cancelButton);
				// 将容器元素添加到文档中
				document.body.appendChild(container);
				console.log(container);
				// 给确定按钮绑定事件
				okButton.onclick = function() {
					var inputText = inputBox.value;
					// 处理输入的内容
					//console.log(inputText+'12');
					cy.add({
						data: {
							id: 'newNode' + String(newnodeindex),
							label: "New",
							name: add_p_name
						}, // 为新节点指定ID
					});
					cy.add({
						data: {
							id: 'newEdge' + String(newnodeindex),
							source: currentid,
							target: 'newNode' + String(newnodeindex),
							relationship: inputText
						} // , relationship:source和target为已有节点ID和新节点ID
					});
					var layout = cy.layout({
						name: 'cose',
						fit: true,
						componentSpacing: 80, //非复合图中组件之间的额外间距  40
						nodeOverlap: 10 //节点排斥(重叠)乘数 4
					});
					layout.run();
					newnodeindex = newnodeindex + 1;
					// 移除容器元素
					document.body.removeChild(container);
				};
				// 给取消按钮绑定事件
				cancelButton.onclick = function() {
					// 移除容器元素
					document.body.removeChild(container);
				};
			}

			function ADD02(parentname) {
				//currentid=node.id();
				//currentname=node.data()['name'];
				//currentid=node.id();
				//currentname=node.data()['name'];
				// 创建一个输入框元素
				var inputtxt = document.createElement("p");
				inputtxt.innerHTML = '新建节点名称为“' + parentname + '”；与已有节点“' + currentname + '”建立“' + currentname + '”->“' +
					parentname + '”关系' + '<br>输入关系的类型：';
				var inputBox = document.createElement('input');
				inputBox.type = 'text';
				console.log(currentid);
				// 创建一个确定按钮元素
				var okButton = document.createElement('button');
				okButton.innerHTML = '确定';
				// 创建一个取消按钮元素
				var cancelButton = document.createElement('button');
				cancelButton.innerHTML = '取消';
				// 创建一个容器元素，用于包含输入框和按钮
				var container = document.createElement('div');
				container.setAttribute("class", "open-end-div");
				container.appendChild(inputtxt);
				container.appendChild(inputBox);
				container.appendChild(okButton);
				container.appendChild(cancelButton);
				// 将容器元素添加到文档中
				document.body.appendChild(container);
				console.log(container);
				// 给确定按钮绑定事件
				okButton.onclick = function() {
					var inputText = inputBox.value;
					// 处理输入的内容
					//console.log(inputText+'12');
					cy.add({
						data: {
							id: 'newNode' + String(newnodeindex),
							label: "New",
							name: parentname
						}, // 为新节点指定ID
					});
					cy.add({
						data: {
							id: 'newEdge' + String(newnodeindex),
							source: currentid,
							target: 'newNode' + String(newnodeindex),
							relationship: inputText
						} // , relationship:source和target为已有节点ID和新节点ID
					});
					var layout = cy.layout({
						name: 'cose',
						fit: true,
						componentSpacing: 80, //非复合图中组件之间的额外间距  40
						nodeOverlap: 10 //节点排斥(重叠)乘数 4
					});
					layout.run();
					newnodeindex = newnodeindex + 1;
					// 移除容器元素
					document.body.removeChild(container);
				};
				// 给取消按钮绑定事件
				cancelButton.onclick = function() {
					// 移除容器元素
					document.body.removeChild(container);
				};
			}

			function forceon() {
				var allElements = cy.elements();
				allElements.style('display', 'element');
				var layout = cy.layout({
					name: 'cose',
					fit: true,
					componentSpacing: 80, //非复合图中组件之间的额外间距  40
					nodeOverlap: 10 //节点排斥(重叠)乘数 4
				});
				layout.run();

				document.getElementById('bcy1').style.fontWeight = "bold";
				document.getElementById('bcy2').style.fontWeight = "normal";
				document.getElementById('bmap').style.fontWeight = "normal";
				//document.getElementById('cy2').style.display = "none";
				document.getElementById('map').style.display = "none";
				document.getElementById('cy1').style.display = "block";
				//cy.container=document.getElementById('cy1');

			}

			function forcetwo() {
				// 获取所有元素
				var allElements = cy.elements();
				// 获取已选择的元素
				var selectedElements = cy.elements(':selected');
				// 获取未选择的元素
				var unselectedElements = allElements.difference(selectedElements);
				// 将未选择的元素设为不可见
				//unselectedElements.filter(':display').style('display', 'none');
				unselectedElements.style('display', 'none');
				var layout = cy.layout({
					name: 'cose',
					fit: true
				});
				layout.run();
				cy.zoom(5);
				document.getElementById('bcy2').style.fontWeight = "bold";
				document.getElementById('bcy1').style.fontWeight = "normal";
				document.getElementById('bmap').style.fontWeight = "normal";
				/*document.getElementById('cy1').style.display = "none";*/
				document.getElementById('map').style.display = "none";
				/*document.getElementById('cy2').style.display = "block";*/
				//cy.container=document.getElementById('cy1');
			}

			function forcemap() {

				document.getElementById('bmap').style.fontWeight = "bold";
				document.getElementById('bcy2').style.fontWeight = "normal";
				document.getElementById('bcy1').style.fontWeight = "normal";
				document.getElementById('cy1').style.display = "none";
				document.getElementById('cy2').style.display = "none";
				document.getElementById('map').style.display = "block";
				//cy.container=document.getElementById('cy1');
			}

			var hdh;
			var before_hdh;

			function submit02() {
				var parent02 = document.getElementsByClassName("form-group0")[0];
				var p02 = document.createElement("p");
				p02.setAttribute("class", "rightp");
				p02.innerHTML = $("#shuru").val();
				parent02.appendChild(p02);

				var ms = $("#shuru").val();
				const user_input = document.getElementById('shuru');
				// get the value and use as needed
				let user_input_value = user_input.value;
				user_input.value = '';

				const searchObj01 = /显示与(.*)相关的节点(.*)层/.exec(ms);
				const searchObj02 = /在(.*)洛阳的名称/.exec(ms); //在(.*)洛阳的名称
				const searchObj03 = /(.*)从古到今的变化/.exec(ms);

				cy.$(':selected').unselect();

				var allElements = cy.elements();

				allElements.forEach(function(ele) {
					if (ele.hasClass()) {
						ele.removeClass();
					}

				});

				allElements.style('opacity', '1');

				cy.style().update();

				if (typeof before_hdh !== 'undefined') {
					hdh.style('background-color', before_hdh);
				}
				if (searchObj01) {
					const A1_01 = searchObj01[1];
					const A1_02 = searchObj01[2];

					var parent02 = document.getElementsByClassName("form-group0")[0];
					var p03 = document.createElement("p");
					p03.setAttribute("class", "leftp");
					p03.innerHTML = '结果将在细节图页面中进行展示';
					parent02.appendChild(p03);

					var myDiv = document.getElementById("coll1");
					myDiv.scrollTop = myDiv.scrollHeight;


					//cy.elements.add(res.elements);
					//cy.add(res.data.elements);

					let str1 = '"' + A1_01 + '"'; //res.data.b


					//let neighborhood = cy.$('[name ='+str1+']').neighborhood().select();
					hdh = cy.$('[name =' + str1 + ']');
					var selectedNode = hdh.select();
					//console.log(typeof hdh);
					//RGBColor
					before_hdh = hdh.css('background-color');
					//console.log(typeof before_hdh);
					hdh.style('background-color', 'red');
					//let neighborhoods = hdh.neighborhood().select();
					//var selectedNodes = cy.filter('node[label="Years"]');
					var a_cengshu = A1_02;
					if (a_cengshu == 'N') {
						a_cengshu = '1';
					}
					n_cengshu = Number(a_cengshu);
					//console.log(n_cengshu);//2,没问题
					var dhd = cy.$('[name =' + str1 + ']');
					for (var i = 0; i < n_cengshu; i++) {
						console.log(dhd);
						var neighborhood = dhd.neighborhood();
						var neighborhoods = neighborhood.select();
						dhd = neighborhood;
					};
					// 获取所有元素
					var allElements = cy.elements();
					// 获取已选择的元素
					var selectedElements = cy.elements(':selected');
					//console.log(selectedElements);
					// 获取未选择的元素
					var unselectedElements = allElements.difference(selectedElements);
					// 将未选择的元素设为不可见
					//unselectedElements.filter(':display').style('display', 'none');
					unselectedElements.style('display', 'none');
					var layout = cy.layout({
						name: 'cose'
					});
					layout.run();

					cy.zoom(5);
					document.getElementById('bcy2').style.fontWeight = "bold";
					document.getElementById('bcy1').style.fontWeight = "normal";
				} else {
					if (searchObj02) {
						var A1_03 = searchObj02[1];
						if (A1_03 == 'Y') {
							A1_03 = '唐朝';
						}
						let str3 = '"' + A1_03 + '"';
						
						php = cy.$('[name =' + str3 + ']');
						php.select();
						before_php = php.css('background-color');
						php.style('background-color', 'red');
						php.addClass('chClass1'); 

						hdh = cy.$('[name = "洛阳"]');
						hdh.select();
						before_hdh = hdh.css('background-color');
						hdh.style('background-color', 'red');
                        hdh.addClass('chClass');
                        
						var nodeIds = cy.nodes().filter(function(node) {
							return node.data('name') === '洛阳';
						}).map(function(node) {
							return '#' + node.id();
						});
						//console.log(nodeIds);
                        
						var bfs = cy.elements().bfs({
							roots: nodeIds[0],
							visit: function(v, e, u, i, depth) {
								//console.log(i);
								var element = e;
								if (typeof element !== 'undefined') {
									//console.log(element);
									if (element.isEdge() && (element.data('relationship') == '改名')) {
										if (u.hasClass('chClass') || v.hasClass('chClass')) {
											//element.addClass('myClass');
											var target = element.target();
											var source = element.source();
											if (target.isNode()) {
												target.addClass('chClass');
												//target.successors().addClass('chClass');
											}
											if (source.isNode()) {
												source.addClass('chClass');
												//source.predecessors().addClass('chClass');
											}
										}
									}
								} else {
									console.log('null');
								}
							}
						});
						
						// 获取所有元素
						var allElements = cy.elements();
						// 按类筛选节点
						var classA = cy.$('.chClass');
						console.log(classA);
						var classB = php.neighborhood('node[label="Place-name"]').filter('node');
						console.log(classB);
						// 获取交集
						var otshownodes = classA.intersection(classB);
						//console.log('otshownodes');
						//console.log(otshownodes.length);
						otshownodes.select();
						const count0=otshownodes.length;
						// 提取交集节点的标签名称
						var tagNames = otshownodes.map(function(node) {
						  return node.data('name');
						});
						
						// 将标签名称拼接为字符串
						var mergedTags = tagNames.join('、');
						// 输出拼接后的字符串
						//console.log(mergedTags);
						
						// 获取已选择的元素
						var selectedElements = cy.elements(':selected');
						//console.log(selectedElements);
						// 获取未选择的元素
						var unselectedElements = allElements.difference(selectedElements);
						// 将未选择的元素设为不可见
						//unselectedElements.filter(':display').style('display', 'none');
						unselectedElements.style('display', 'none');
						// iterate through all the edges of the selected node
						selectedElements.connectedEdges().forEach(function(edge) {
							// check if both source and target nodes are selected
							if (edge.source().is(':selected') && edge.target().is(':selected')) {
								// set the line color of the edge to red
								edge.style('display', 'element');
							}
						});
						cy.style().update();
						
						var parent02 = document.getElementsByClassName("form-group0")[0];
						var p03 = document.createElement("p");
						p03.setAttribute("class", "leftp");
						
						function digitToChinese(num) {
						  var chineseNums = ["零", "一", "二", "三", "四", "五", "六", "七", "八", "九"];
						  return chineseNums[num];
						}
						
						
						var chinesecount0 = digitToChinese(count0);
						//console.log(chineseDigit); // 输出：五
						
						p03.innerHTML = '在'+A1_03+'洛阳的名称有'+mergedTags+chinesecount0+'个，具体时间可以通过查看“改名”关系的属性得知。';
						parent02.appendChild(p03);
						var myDiv = document.getElementById("coll1");
						myDiv.scrollTop = myDiv.scrollHeight;
						console.log('p1p1');
						
					} else {
						if (searchObj03) {
							var A1_04 = searchObj03[1];
							console.log('all');
							if (A1_04 == 'A') {
								A1_04 = '洛阳'
							}
							let str4 = '"' + A1_04 + '"'; //res.data.b

							hdh = cy.$('[name =' + str4 + ']');
							//console.log(typeof hdh);
							//RGBColor
							before_hdh = hdh.css('background-color');
							//console.log(typeof before_hdh);
							hdh.style('background-color', 'red');

							var nodeIds = cy.nodes().filter(function(node) {
								return node.data('name') === A1_04;
							}).map(function(node) {
								return '#' + node.id();
							});
							//console.log(nodeIds[0]);


							hdh.addClass('chClass');


							var bfs = cy.elements().bfs({
								roots: nodeIds[0],
								visit: function(v, e, u, i, depth) {
									//console.log(i);
									var element = e;
									if (typeof element !== 'undefined') {
										//console.log(element);
										if (element.isEdge() && (element.data('relationship') == '改名')) {
											if (u.hasClass('chClass') || v.hasClass('chClass')) {
												//element.addClass('myClass');
												var target = element.target();
												var source = element.source();
												if (target.isNode()) {
													target.addClass('chClass');
													//target.successors().addClass('chClass');
												}
												if (source.isNode()) {
													source.addClass('chClass');
													//source.predecessors().addClass('chClass');
												}
											}
										}
									} else {
										console.log('null');
									}
								}
							});
							////'edge[relationship="start_in"]'
							//var nodes = cy.$('.myClass').neighborhood('node[label="A"]').filter('node');
							

							var otshownodes = cy.$('.chClass').neighborhood('node[label="Dynasty"]').filter('node');
							console.log(otshownodes);
							otshownodes.addClass('chsClass');
							cy.$('.chClass').select();
							cy.$('.chsClass').select();

							// 获取所有元素
							var allElements = cy.elements();
							// 获取已选择的元素
							var selectedElements = cy.elements(':selected');
							//console.log(selectedElements);
							// 获取未选择的元素
							var unselectedElements = allElements.difference(selectedElements);
							// 将未选择的元素设为不可见
							//unselectedElements.filter(':display').style('display', 'none');
							unselectedElements.style('opacity', '0.2');

							// get the selected node
							var selectedNode036 = cy.$('node:selected');

							// iterate through all the edges of the selected node
							selectedNode036.connectedEdges().forEach(function(edge) {

								// check if both source and target nodes are selected
								if (edge.source().is(':selected') && edge.target().is(':selected')) {

									// set the line color of the edge to red
									edge.style('opacity', '1');
								}
							});


							//selectedElements.connectedEdges().style('opacity', '1');
							cy.style().update();
							var parent02 = document.getElementsByClassName("form-group0")[0];
							var p03 = document.createElement("p");
							p03.setAttribute("class", "leftp");
							p03.innerHTML = '结果将在全图页面中进行展示';
							parent02.appendChild(p03);
							var myDiv = document.getElementById("coll1");
							myDiv.scrollTop = myDiv.scrollHeight;
							/*
							var layout = cy.layout({
								name: 'cose'
							});
							layout.run();
							
							cy.zoom(5);
							document.getElementById('bcy2').style.fontWeight = "bold";
							document.getElementById('bcy1').style.fontWeight = "normal";*/
							console.log('wancheng');
						} else {
							balert('很抱歉，您输入的问题暂时没有被收录');
						}
					}
				}

			}




			document.onkeydown = function(e) {
				if ((e || event).keyCode == 13 && $("#shuru").val().length > 0)
					submit02();
			};

			function TG02(s) {
				var map;
				var zoom = 10;
				//console.log(s);
				s_lon = s.split(", ")[0];
				s_lat = s.split(", ")[1];
				document.getElementById('map').style.display = "block";
				document.getElementById('cy1').style.display = "none";
				document.getElementById('bmap').style.fontWeight = "bold";
				document.getElementById('bcy2').style.fontWeight = "normal";
				document.getElementById('bcy1').style.fontWeight = "normal";
				//初始化地图对象
				map = new T.Map("map");
				//设置显示地图的中心点和级别
				map.centerAndZoom(new T.LngLat(s_lon, s_lat), zoom);
				var point = new T.LngLat(s_lon, s_lat);
				var marker = new T.Marker(point); // 创建标注
				var varmarker = {
					"id": "点0",
					"lng": 0,
					"lat": 0
				}; //初始varmarker
				varmarker["id"] = "点" + (1).toString();
				varmarker["lng"] = s_lon;
				varmarker["lat"] = s_lat;
				//markers.push(varmarker); //加入到markers中
				map.addOverLay(marker); //画出标注
			}

			function CN01(ttt) {
				axios.post("/CN02", {
					t02: ttt
				}).then((res) => {
					//console.log(res.data);
					var arr = res.data['ret'];
					if (res.data['status'] = 'ok') {
						var ss = '成功'
					} else {
						var ss = '失败'
					}
					res.data['status']
					balert('获取' + ss);
					var txt = '<table><thead><tr><th>属性名(+)</th><th>属性值</th></tr></thead><tbody>';
					for (var i = 0; i < arr.length; i++) {
						txt +=
							'<tr><td>' +
							'<u class="buttonu" onclick="ADD01(&quot;' +
							arr[i][1] +
							'&quot;)">' +
							arr[i][0] +
							'</u>' +
							'</td><td>' +
							arr[i][1] +
							'</td></tr>';
					};
					txt += '</tbody></table>';
					$('#nodeCN').html(txt); //res.data

				}).catch(error => {
					console.error(error);
				})
			};

			function ch1() {
				const checkbox = document.querySelector('input[name="p1"]');
				var selectedNodes = cy.filter('node[label="Place-name"]');
				if (checkbox.checked) {
					//console.log("Option 1 is checked");
					selectedNodes.style('display', 'element');
				} else {
					//console.log("Option 1 is not checked");
					selectedNodes.style('display', 'none');
					//selectedNodes.style('background-color', 'red');
				}
				var layout = cy.layout({
					name: 'cose'
				});
				layout.run();
			}

			function ch2() {
				const checkbox = document.querySelector('input[name="y2"]');
				var selectedNodes = cy.filter('node[label="Dynasty"]');
				if (checkbox.checked) {
					selectedNodes.style('display', 'element');
					//console.log("Option 1 is checked");
				} else {
					// 将所选节点的背景颜色更改为红色
					selectedNodes.style('display', 'none');
					//selectedNodes.style('background-color', 'red');
				}
				var layout = cy.layout({
					name: 'cose'
				});
				layout.run();
			}

			/*function ch3() {
				const checkbox = document.querySelector('input[name="y3"]');
				var selectedNodes = cy.filter('node[label="Years"]');
				if (checkbox.checked) {
					selectedNodes.style('display', 'element');
				} else {
					selectedNodes.style('display', 'none');
				}
				//selectedNodes.style('background-color', 'red');
				var layout = cy.layout({
					name: 'cose'
				});
				layout.run();
			}*/

			function por1() {
				const checkbox = document.querySelector('input[name="p0p1"]');
				var selectedEdges = cy.filter('edge[relationship="next"]');
				if (checkbox.checked) {
					selectedEdges.style('display', 'element');
				} else {
					selectedEdges.style('display', 'none');
				}
				//selectedNodes.style('background-color', 'red');
				var layout = cy.layout({
					name: 'cose'
				});
				layout.run();
			}

			function por2() {
				const checkbox = document.querySelector('input[name="p0p2"]');
				var selectedEdges = cy.filter('edge[relationship="contain"]');
				if (checkbox.checked) {
					selectedEdges.style('display', 'element');
				} else {
					selectedEdges.style('display', 'none');
				}
				//selectedNodes.style('background-color', 'red');
				var layout = cy.layout({
					name: 'cose'
				});
				layout.run();
			}

			function por3() {
				const checkbox = document.querySelector('input[name="p0p3"]');
				var selectedEdges = cy.filter('edge[relationship="start_in"]');
				if (checkbox.checked) {
					selectedEdges.style('display', 'element');
				} else {
					selectedEdges.style('display', 'none');
				}
				//selectedNodes.style('background-color', 'red');
				var layout = cy.layout({
					name: 'cose'
				});
				layout.run();
			}

			function por4() {
				const checkbox = document.querySelector('input[name="p0p4"]');
				//var selectedEdges = cy.filter('edge[relationship="next"]');
				//新建
				var selectedEdges = cy.edges().filter(function(ele) {
					var name = ele.data('relationship');
					return name === '新建'; //置、复置、成立、设、设立
				});
				if (checkbox.checked) {
					selectedEdges.style('display', 'element');
				} else {
					selectedEdges.style('display', 'none');
				}
				//selectedNodes.style('background-color', 'red');
				var layout = cy.layout({
					name: 'cose'
				});
				layout.run();
			}

			function por5() {
				const checkbox = document.querySelector('input[name="p0p5"]');
				//var selectedEdges = cy.filter('edge[relationship="next"]');
				//新建
				var selectedEdges = cy.edges().filter(function(ele) {
					var name = ele.data('relationship');
					return name === '撤销'; //废、撤销
				});
				if (checkbox.checked) {
					selectedEdges.style('display', 'element');
				} else {
					selectedEdges.style('display', 'none');
				}
				//selectedNodes.style('background-color', 'red');
				var layout = cy.layout({
					name: 'cose'
				});
				layout.run();
			}

			function por6() {
				const checkbox = document.querySelector('input[name="p0p6"]');
				//var selectedEdges = cy.filter('edge[relationship="next"]');
				//新建
				var selectedEdges = cy.edges().filter(function(ele) {
					var name = ele.data('relationship');
					return name === '改名'; //改、改为、改曰、改称、更、称、变为
				});
				if (checkbox.checked) {
					selectedEdges.style('display', 'element');
				} else {
					selectedEdges.style('display', 'none');
				}
				//selectedNodes.style('background-color', 'red');
				var layout = cy.layout({
					name: 'cose'
				});
				layout.run();
			}

			function por7() {
				const checkbox = document.querySelector('input[name="p0p7"]');
				//var selectedEdges = cy.filter('edge[relationship="next"]');
				//新建
				var selectedEdges = cy.edges().filter(function(ele) {
					var name = ele.data('relationship');
					return name === '管辖'; //辖、治
				});
				if (checkbox.checked) {
					selectedEdges.style('display', 'element');
				} else {
					selectedEdges.style('display', 'none');
				}
				//selectedNodes.style('background-color', 'red');
				var layout = cy.layout({
					name: 'cose'
				});
				layout.run();
			}

			function por8() {
				const checkbox = document.querySelector('input[name="p0p8"]');
				//var selectedEdges = cy.filter('edge[relationship="next"]');
				//新建
				var selectedEdges = cy.edges().filter(function(ele) {
					var name = ele.data('relationship');
					return name === '被管辖'; //属、改属、改隶、并入
				});
				if (checkbox.checked) {
					selectedEdges.style('display', 'element');
				} else {
					selectedEdges.style('display', 'none');
				}
				//selectedNodes.style('background-color', 'red');
				var layout = cy.layout({
					name: 'cose'
				});
				layout.run();
			}
		</script>
	</body>
</html>
